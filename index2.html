<!doctype html>
<html>

<head>
    <title>Socket.IO chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font: 20px Helvetica, Arial;
        }

        #tic-tac-toe {
            border-collapse: collapse;
            padding: 0;
        }

        #tic-tac-toe td {
            display: inline-block;
            height: 100px;
            width: 100px;
            border: 2px solid black;
            text-align: center;
            padding-top: 40px;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <!--Se define una tabla de 9 cuadrados con 3 arreglos ordenados uno al lado del otro -->
        <table id="tic-tac-toe">
            <tr>
                <td class="square"></td>
                <td class="square"></td>
                <td class="square"></td>
            </tr>
            <tr>
                <td class="square"></td>
                <td class="square"></td>
                <td class="square"></td>
            </tr>
            <tr>
                <td class="square"></td>
                <td class="square"></td>
                <td class="square"></td>
            </tr>
        </table>
        <div id="play-log"></div>
    </div>
    <!--Aquí comienza la llamada de scripts-->

    <!--Se llama a socket.io para manejar las conexiones entre socket-->
    <script src="/socket.io/socket.io.js"></script>
    <!--Se llama a jQuery para simplificar algunas funciones de JS-->
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
        $(function () {
            //Se define una variable para recibir los valores de socket
            var socket = io();
            //Se define una variable para un símbolo de ejemplo, se puede remover
            var mySymbol = '@';
            //Se define una zona de juego creada con un arreglo de 9 espacios
            var playlist = new Array(9);
            //Variable para definir condición de comienzo de juego
            var onThePlay = false;

            //Función para recibir datos de socket al momento de iniciar el juego
            socket.on('play', function (message) {
                //Manejo de errores al iniciar el juego
                try {
                    //Variable para mostrar mensajes en el juego
                    var playData = JSON.parse(message);
                    //Condición para verificar que no exista un símbolo en celda, para evitar sobreescritura
                    if (playData.symbol !== mySymbol) {
                        onThePlay = true;
                    }
                    //Si cumple con la condición, dibuja en una celda
                    drawPlay(playData);
                } catch (e) {
                    logPlay('Vaya, algo ha fallado, por favor recarga la pagina');
                    console.log(e.message);
                }
            });

            //Función para recibir datos de socket para designar símbolos a los jugadores
            socket.on('symbol', function (message) {
                //Se asigna el símbolo al mensaje y se muestra en pantalla
                mySymbol = message;
                logPlay('Te han asignado el simbolo: [' + mySymbol + ']');

                //Condición para asignar el símbolo O, en este caso el primero jugador siempre es O
                if (mySymbol === 'O') {
                    onThePlay = true;
                    logPlay('Tu juegas primero')
                } else {
                    logPlay('Tu juegas segundo')
                }
            });

            //Socket para recibir datos para finalizar el juego
            socket.on('finish', function (message) {
                onThePlay == false;
            });

            //Obtiene los elementos de los cuadrados, que son posiciones en el arreglo
            $('.square').on('click', function (e) {
                //Declara una variable y la asigna al índice del objeto para mantener la posición guardada
                var index = $('#tic-tac-toe td').index(this);
                //Se declara una variable para guardar la última jugada
                var playData = play(index);

                //Condición para definir el turno de la persona
                if (!onThePlay) {
                    logPlay('Debes esperar tu turno para jugar');
                    return;
                }

                //Condición que compara el índice guardado con el índice actual
                if (playData.index === index) {
                    //Emite información sobre la última jugada y lo muestra por pantalla
                    socket.emit('play', JSON.stringify(playData));
                    //Cambia el turno de jugador
                    onThePlay = false;
                }
            });

            //Función para dibujar los símbolos en las celdas
            function drawPlay(playData) {
                //Se guarda el símbolo de la jugada en el índice del arreglo de la zona de juego
                playlist[playData.index] = playData.symbol;
                //Equivale el valor del símbolo dibujado en la celda con el símbolo asignado por playData
                $('#tic-tac-toe td').eq(playData.index).text(playData.symbol);
                //Se declara una variable de coordinadas para guardar el índice, dentro del arreglo, de la jugada
                var coordinates = getPlayCoordinates(playData.index);
                //Llama a la función logPlay para indicar el símbolo jugado en la coordinada indicada
                logPlay('player [' + playData.symbol + '] play: [' + coordinates.x + '][' + coordinates.y + ']');
                console.log(playlist);
            }

            //Función para validar una jugada y aplicar jugada en la celda
            function play(index) {
                //Condición para validar si una celda está ocupada por una jugada anterior
                if (typeof playlist[index] !== 'undefined') {
                    logPlay('Celda ocupada por una jugada anterior');
                    return {};
                }
                console.log('index: ' + index);

                //Se declara una variable para guardar un índice
                var coordinates = getPlayCoordinates(index);
                console.log('play position: [' + coordinates.x + '][' + coordinates.y + ']');
                return {
                    symbol: mySymbol,
                    index: index
                };
            }

            //Función para mostrar mensajes en pantalla, debajo de la zona de juego
            function logPlay(message) {
                var playLog = $('#play-log');
                playLog.html(playLog.html() + '<br/>' + message);
            }

            //Función para obtener coordenadas desde la zona de juego
            function getPlayCoordinates(index) {
                var x = Math.floor((index) / 3) + 1;
                var y = index - (x - 1) * 3 + 1;
                return {
                    x: x,
                    y: y
                };
            }
        });
    </script>
</body>

</html>